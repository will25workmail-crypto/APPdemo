<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Pipeline</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body { background:#000; margin:0; }
    .header { padding:16px; text-align:center; font-weight:900; font-size:20px; background:#000; border-bottom:2px solid #333; }
    .square { width: 360px; height: 480px; margin:40px auto; border:4px solid #333; border-radius:16px; overflow:hidden; background:#111; position:relative; }
    .grid { display:grid; grid-template-columns:repeat(5,1fr); gap:4px; height:100%; padding:6px; }
    .column { background:#111; display:flex; flex-direction:column; }
    .title { padding:6px 4px; text-align:center; font-weight:bold; font-size:11px; }
    .cards { flex:1; overflow-y:auto; padding:2px; }
    .card { background:#f9fafb; color:#000; margin:3px; padding:6px 5px; border-radius:6px; font-size:9px; line-height:1.3; box-shadow:0 1px 3px rgba(0,0,0,0.4); cursor:pointer; }
    .name { font-weight:bold; word-break:break-word; hyphens:auto; }
    .tag { font-size:8px; padding:1px 4px; border-radius:3px; display:inline-block; margin-top:2px; }
    .hot { background:#ef4444; color:white; }
    .warm { background:#f97316; color:white; }
    .cold { background:#6b7280; color:white; }

    /* Modal INSIDE the square */
    .modal { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:100; justify-content:center; align-items:center; }
    .modal-content { background:#1f2937; padding:20px; border-radius:12px; max-width:85%; color:white; position:relative; text-align:center; }
    .close { position:absolute; top:8px; right:12px; font-size:28px; cursor:pointer; }
  </style>
</head>
<body>

<div class="header">Pipeline</div>

<div class="square">
  <div class="grid">
    <div class="column"><div class="title bg-blue-600">New Lead</div><div class="cards" id="chatbot-lead"></div></div>
    <div class="column"><div class="title bg-purple-600">Appt Set</div><div class="cards" id="appt-set"></div></div>
    <div class="column"><div class="title bg-green-600">Showed</div><div class="cards" id="showed"></div></div>
    <div class="column"><div class="title bg-orange-600">Sold</div><div class="cards" id="sold"></div></div>
    <div class="column"><div class="title bg-red-600">Lost</div><div class="cards" id="lost"></div></div>
  </div>

  <!-- Modal now inside .square -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close">×</span>
      <div id="modal-name" class="text-xl font-bold mb-3"></div>
      <div id="modal-phone" class="text-lg mb-2"></div>
      <div id="modal-vehicle" class="text-lg mb-4"></div>
      <div id="modal-tag" class="inline-block px-4 py-2 text-lg font-bold rounded-full"></div>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzleiQlkUV9lQ4jo0jDeY2Wi2hqazb25c6_1gtC2faim5rSYBIRfbBRErKopGOM6fnVEg/exec'

async function loadLeads() {
  const res = await fetch(SCRIPT_URL + '?t=' + Date.now())
  const leads = await res.json()
  document.querySelectorAll('.cards').forEach(c => c.innerHTML = '')

  leads.forEach((l, i) => {
    const card = document.createElement('div')
    card.dataset.row = i + 2
    card.className = 'card'
    card.onclick = () => showModal(l)

    const name = l.Name || l['C1: Name'] || '—'
    const isHot = (l['Lead Type'] || l['A1: Lead Type'] || '').toLowerCase().trim() === 'hot'
    const isCold = (l['Lead Type'] || l['A1: Lead Type'] || '').toLowerCase().includes('cold')

    card.innerHTML = `
      <div class="name">${name}</div>
      <span class="tag ${isHot ? 'hot' : isCold ? 'cold' : 'warm'}">
        ${isHot ? 'HOT' : isCold ? 'COLD' : 'WARM'}
      </span>
    `

    let target = 'chatbot-lead'
    const stage = (l.Stage || l.stage || '').toLowerCase()
    if (stage.includes('appt')) target = 'appt-set'
    else if (stage.includes('show')) target = 'showed'
    else if (stage.includes('sold') || stage.includes('delivered')) target = 'sold'
    else if (stage.includes('lost')) target = 'lost'

    document.getElementById(target).appendChild(card)
  })

  const stages = ['chatbot-lead','appt-set','showed','sold','lost']
  stages.forEach(s => new Sortable(document.getElementById(s), { group: 'pipeline', animation: 120, onEnd: e => fetch(`${SCRIPT_URL}?row=${e.item.dataset.row}&stage=${e.to.id}`, {method: 'POST'}) }))
}

function showModal(l) {
  document.getElementById('modal-name').textContent = l.Name || l['C1: Name'] || '—'
  document.getElementById('modal-phone').textContent = l.Phone || l['D1: Phone'] || ''
  document.getElementById('modal-vehicle').textContent = l['Vehicle Type'] || l['G1: Vehicle Type'] || ''
  const tag = document.getElementById('modal-tag')
  const isHot = (l['Lead Type'] || l['A1: Lead Type'] || '').toLowerCase().trim() === 'hot'
  const isCold = (l['Lead Type'] || l['A1: Lead Type'] || '').toLowerCase().includes('cold')
  tag.textContent = isHot ? 'HOT' : isCold ? 'COLD' : 'WARM'
  tag.className = isHot ? 'bg-red-600' : isCold ? 'bg-gray-600' : 'bg-orange-600'
  document.getElementById('modal').style.display = 'flex'
}

document.querySelector('.close').onclick = () => document.getElementById('modal').style.display = 'none'
document.getElementById('modal').onclick = e => { if (e.target.id === 'modal') document.getElementById('modal').style.display = 'none' }

loadLeads()
setInterval(loadLeads, 10000)
</script>
</body>
</html>